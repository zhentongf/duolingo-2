name: Keep my Duolingo streak
on:
  schedule:
    - cron: 0 17 * * *
jobs:
  study:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate DUOLINGO_JWT secrets
        run: |
          if [ -z "${{ secrets.DUOLINGO_JWT }}" ]; then
            echo "‚ùå DUOLINGO_JWT is missing"
            exit 1
          fi
          if [ -z "${{ secrets.DUOLINGO_JWT_2 }}" ]; then
            echo "‚ùå DUOLINGO_JWT_2 is missing"
            exit 1
          fi
          if [ -z "${{ secrets.DUOLINGO_JWT_3 }}" ]; then
            echo "‚ùå DUOLINGO_JWT_3 is missing"
            exit 1
          fi
        shell: bash
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
      - name: Run Duolingo automation (account 1)
        id: duolingo_1
        env:
          DUOLINGO_JWT: ${{ secrets.DUOLINGO_JWT }}
          LESSONS: 1
        run: |
          OUTPUT=$(bun index.js 2>&1)
          echo "$OUTPUT"
          echo "result=$OUTPUT" >> $GITHUB_OUTPUT
      - name: Run Duolingo automation (account 2)
        id: duolingo_2
        env:
          DUOLINGO_JWT: ${{ secrets.DUOLINGO_JWT_2 }}
          LESSONS: 1
        run: |
          OUTPUT=$(bun index.js 2>&1)
          echo "$OUTPUT"
          echo "result=$OUTPUT" >> $GITHUB_OUTPUT

      - name: Run Duolingo automation (account 3)
        id: duolingo_3
        env:
          DUOLINGO_JWT: ${{ secrets.DUOLINGO_JWT_3 }}
          LESSONS: 1
        run: |
          OUTPUT=$(bun index.js 2>&1)
          echo "$OUTPUT"
          echo "result=$OUTPUT" >> $GITHUB_OUTPUT
      - name: Notify Discord on success
        if: success()
        run: >
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üü¢ Duolingo streak succeeded!\n\nAccount 1:\n${{ steps.duolingo_1.outputs.result }}\n\nAccount 2:\n${{ steps.duolingo_2.outputs.result }}\n\nAccount 3:\n${{ steps.duolingo_3.outputs.result }}\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}
      - name: Send failure email via Resend
        if: failure()
        run: |
          curl -X POST "https://api.resend.com/emails" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -d '{
              "from": "Duolingo Bot <f02-mail@ronf.top>",
              "to": ["${{ secrets.NOTIFY_EMAIL }}"],
              "subject": "‚ùå Duolingo streak failed",
              "html": "<p>The daily Duolingo task failed.</p><p>Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}</p>"
            }'

  delete-old-runs:
    needs: study
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          keep_minimum_runs: 0
          retain_days: 0
