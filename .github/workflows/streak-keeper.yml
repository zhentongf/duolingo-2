name: Keep my Duolingo streak
on:
  schedule:
    - cron: 0 17 * * *
  # workflow_dispatch:
  #   inputs:
  #     lessons:
  #       default: 1
  #       description: Number of lessons to complete
  #       type: number
  #       required: false
jobs:
  study:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate DUOLINGO_JWT secret
        run: |
          if [ -z "${{ secrets.DUOLINGO_JWT }}" ]; then
            echo "‚ùå ERROR: DUOLINGO_JWT is missing"
            exit 1
          fi
        shell: bash
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
      - name: Run Duolingo automation
        id: duolingo
        run: |
          echo "Running daily streak task..."
          OUTPUT=$(bun index.js 2>&1)
          echo "$OUTPUT"
          echo "result=$OUTPUT" >> $GITHUB_OUTPUT
        env:
          DUOLINGO_JWT: ${{ secrets.DUOLINGO_JWT }}
          LESSONS: 1
      - name: Notify Discord
        if: success()
        run: >
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"üü¢ Duolingo streak run succeeded! Output:\n${{ steps.duolingo.outputs.result }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
      - name: Send failure email via Resend
        if: failure()
        run: |
          curl -X POST "https://api.resend.com/emails" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -d '{
              "from": "Duolingo Bot <f02-mail@ronf.top>",
              "to": ["${{ secrets.NOTIFY_EMAIL }}"],
              "subject": "‚ùå Duolingo streak failed",
              "html": "<p>The daily Duolingo task failed.</p><p>Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}</p>"
            }'

  delete-old-runs:
    needs: study
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          keep_minimum_runs: 0
          retain_days: 0
